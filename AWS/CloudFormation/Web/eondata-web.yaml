Description: Creates the EonData.net website
Parameters:
    WebHostKeyPair:
        Description: The EC2 KeyPair to use when creating the web host instances.
        Type: AWS::EC2::KeyPair::KeyName
        Default: eondata-web
    EonDataWebAppBucketName:
        Description: Name of the S3 bucket that will host the angular webapp.
        Type: String
        Default: eondataweb
    EonDataWebDataBucketName:
        Description: Name of the S3 bucket that stores data used by the website.
        Type: String
        Default: eondataweb-data
    EonDataWebAppCertArn:
        Description: ARN of the certificate to use for the webapp. This needs to be deployed to us-east-1 to work with CloudFront.
        Type: String
    EonDataWebApiCertArn:
        Description: ARN of the certificate to use for the webapp. This needs to be deployed to us-east-1 to work with CloudFront.
        Type: String
    BastionSecurityGroupId:
        Description: The security group id the bastion host belongs to.
        Type: String
    TargetVPC:
        Description: VPC to launch the bastion host in.
        Type: AWS::EC2::VPC::Id
    WebHostInstanceType:
        Description: The EC2 instance type to use when creating the bastion host.
        Type: String
        Default: t3.small
    WebHostSubnets:
        Description: The subnets to deploy the web host instances to. These should be private subnets.
        Type: List<AWS::EC2::Subnet::Id>
    # get the latest amazon linux 2 ami id
    LatestAmiId:
        Description: This is the latest Amazon Linux 2 AMI which will be used for the EC2 instances.
        Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
        Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
Resources:
    EonDataWebAppS3Bucket:
        Type: AWS::S3::Bucket
        Properties:
            BucketName: !Ref EonDataWebAppBucketName
            AccessControl: PublicRead
            WebsiteConfiguration:
                IndexDocument: index.html
                ErrorDocument: index.html
    EonDataWebAppS3Policy:
        Type: AWS::S3::BucketPolicy
        Properties:
            Bucket: !Ref EonDataWebAppS3Bucket
            PolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Sid: "PublicReadGetObject"
                      Effect: "Allow"
                      Principal:
                        AWS: !Sub arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${EonDataWebOriginAccess}
                      Action: "s3:GetObject"
                      Resource: !Join ["", ["arn:aws:s3:::", !Ref EonDataWebAppBucketName, "/*"]]
    EonDataWebDataS3Bucket:
        Type: AWS::S3::Bucket
        DeletionPolicy: Retain
        Properties:
            BucketName: !Ref EonDataWebDataBucketName
            AccessControl: Private
            PublicAccessBlockConfiguration:
                BlockPublicAcls: true
                BlockPublicPolicy: true
                IgnorePublicAcls: true
                RestrictPublicBuckets: true
    EonDataWebDataS3Policy:
        Type: AWS::S3::BucketPolicy
        Properties:
            Bucket: !Ref EonDataWebDataS3Bucket
            PolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Sid: WebAppCFLogs
                      Effect: Allow
                      Principal:
                        AWS: !Sub arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${EonDataWebOriginAccess}
                      Action:
                        - s3:GetBucketAcl
                        - s3:PutBucketAcl
                      Resource: !Sub arn:aws:s3:::${EonDataWebDataBucketName}
    EonDataWebAppCloudFrontDistribution:
        Type: AWS::CloudFront::Distribution
        Properties:
            DistributionConfig:
                Enabled: true
                Comment: EonData web app distribution
                HttpVersion: http2
                Aliases:
                    - www.eondata.net
                ViewerCertificate:
                    AcmCertificateArn: !Ref EonDataWebAppCertArn
                    SslSupportMethod: sni-only
                    MinimumProtocolVersion: TLSv1.2_2021
                DefaultRootObject: index.html
                Origins:
                    - Id: EonDataWebAppS3Origin
                      DomainName: !Sub ${EonDataWebAppBucketName}.s3.amazonaws.com
                      S3OriginConfig:
                        OriginAccessIdentity: !Sub origin-access-identity/cloudfront/${EonDataWebOriginAccess}
                    #   OriginCustomHeaders:
                    #     - HeaderName: Access-Control-Allow-Origin
                    #       HeaderValue: "'*'"
                      OriginPath: ''
                DefaultCacheBehavior:
                    TargetOriginId: EonDataWebAppS3Origin
                    ForwardedValues:
                        QueryString: false
                        Cookies:
                            Forward: none
                    ViewerProtocolPolicy: redirect-to-https
                    MinTTL: 0
                    AllowedMethods:
                        - GET
                        - HEAD
                        - OPTIONS
                    CachedMethods:
                        - GET
                        - HEAD
                    DefaultTTL: 3600
                    MaxTTL: 86400
                CustomErrorResponses:
                    - ErrorCode: 404
                      ResponsePagePath: /index.html
                      ResponseCode: '200'
                      ErrorCachingMinTTL: 300
                Logging:
                    Bucket: !Sub ${EonDataWebDataBucketName}.s3.amazonaws.com
                    Prefix: logs/webapp/cf/
                    IncludeCookies: false
    EonDataWebOriginAccess:
        Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
        Properties:
            CloudFrontOriginAccessIdentityConfig:
                Comment: EonData Web App CloudFront Origin
    EonDataWebLogGroup:
        Type: AWS::Logs::LogGroup
        Properties:
            LogGroupName: eondataweb
            RetentionInDays: 120
    EonDataApiHostEC2Security:
        Type: AWS::EC2::SecurityGroup
        Properties:
          GroupName: EonDataApiHostEC2Security
          GroupDescription: Controls access to the eondream website web ec2 servers.
          VpcId: !Ref TargetVPC
    EonDataApiHostAllowAllHTTP:
        Type: AWS::EC2::SecurityGroupIngress
        Properties:
            Description: Allow HTTP accerss from everywhere to the API server.
            GroupId: !GetAtt EonDataApiHostEC2Security.GroupId
            IpProtocol: tcp
            FromPort: 80
            ToPort: 80
            CidrIp: 0.0.0.0/0
    EonDataApiHostAllowBastionSSH:
        Type: AWS::EC2::SecurityGroupIngress
        Properties:
            Description: Allows SSH access to the API hosts from the bastion server.
            GroupId: !GetAtt EonDataApiHostEC2Security.GroupId
            IpProtocol: tcp
            FromPort: 22
            ToPort: 22
            SourceSecurityGroupId: !Ref BastionSecurityGroupId
    EonDataApiHostLaunchTemplate:
        Type: AWS::EC2::LaunchTemplate
        Properties:
            LaunchTemplateName: EonDataApiHostTemplate
            LaunchTemplateData:
                ImageId: !Ref LatestAmiId
                InstanceInitiatedShutdownBehavior: terminate
                InstanceType: !Ref WebHostInstanceType
                IamInstanceProfile:
                    Arn: !GetAtt EonDataApiHostIAMProfile.Arn
                CreditSpecification:
                    CpuCredits: standard
                KeyName: !Ref WebHostKeyPair
                SecurityGroupIds:
                    - !Ref EonDataApiHostEC2Security
                UserData:
                  Fn::Base64: !Sub |
                    #!/bin/bash
                    yum update -y
                    yum install -y aws-cfn-bootstrap
                    /opt/aws/bin/cfn-init --stack ${AWS::StackName} --resource EonDataApiHostLaunchTemplate --region ${AWS::Region} --configsets Setup
        Metadata:
            AWS::CloudFormation::Init:
                configSets:
                    Setup:
                      - init
                      - inst
                      - cfgs
                init:
                  # initialize environment and logging
                  packages:
                    yum:
                      awslogs: []
                      jq: []
                      htop: []
                  groups:
                    eondata_nginx: {}
                  users:
                    eondata:
                      groups:
                        - "eondata_nginx"
                      homeDir: /home/eondata
                  files:
                    /etc/awslogs/awscli.conf:
                        mode: "000400"
                        content: !Sub |
                            [plugins]
                            cwlogs = cwlogs
                            [default]
                            region = ${AWS::Region}
                    /etc/awslogs/awslogs.conf:
                        mode: "000400"
                        content: !Sub |
                            [general]
                            state_file = /var/lib/awslogs/agent-state
                            use_gzip_http_content_encoding = true
                            queue_size = 10

                            [cfn-init]
                            file = /var/log/cfn-init.log
                            log_group_name = ${EonDataWebLogGroup}
                            log_stream_name = api cfn-init {instance_id}
                            datetime_format = %Y-%m-%d %H:%M:%S,%f
                            time_zone = UTC
                            multi_line_start_pattern = {datetime_format}

                            [sshd]
                            file = /var/log/secure
                            log_group_name = ${EonDataWebLogGroup}
                            log_stream_name = api sshd {instance_id}
                            datetime_format = %b %d %H:%M:%S

                            [nginx_access]
                            file = /var/log/nginx/access.log
                            log_group_name = ${EonDataWebLogGroup}
                            log_stream_name = api nginx_access {instance_id}
                            datetime_format = %d/%b/%Y:%H:%M:%S %z
                            time_zone = UTC

                            [nginx_error]
                            file = /var/log/nginx/error.log
                            log_group_name = ${EonDataWebLogGroup}
                            log_stream_name = api nginx_error {instance_id}
                            datetime_format = %Y/%m/%d %H:%M:%S
                            time_zone = UTC
                    /etc/systemd/system/eondata-api.service:
                        mode: "00400"
                        content: !Sub |
                            [Unit]
                            Description=EonData API
                            Requires=eondata-api.socket

                            [Service]
                            WorkingDirectory=/home/eondata/webapi
                            ExecStart=/usr/bin/dotnet /home/eondata/webapi/EonData.Api.dll
                            User=eondata
                            Group=eondata
                            Environment=ASPNETCORE_ENVIRONMENT=Production
                            Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false
                            Type=notify
                            Restart=always
                            RestartSec=10

                            [Install]
                            WantedBy=multi-user.target
                    /etc/systemd/system/eondata-api.socket:
                        mode: "00400"
                        content: !Sub |
                            [Unit]
                            Description=EonData API Socket

                            [Socket]
                            ListenStream=/run/eondata-api.sock
                            SocketUser=eondata
                            SocketGroup=eondata_nginx
                            SocketMode=0660

                            [Install]
                            WantedBy=sockets.target
                  commands:
                    awslogsenabl:
                        command: systemctl enable awslogsd
                    awslogsstart:
                        command: systemctl start awslogsd
                    chgsshconfig:
                        command: echo "LogLevel VERBOSE" >> /etc/ssh/sshd_config
                    chgsshrestrt:
                        command: systemctl restart sshd
                    eondatacreatehome:
                        command: mkdir -m 0700 /home/eondata
                    eondatasetowner:
                        command: chown eondata:eondata /home/eondata
                    msrepoadd:
                        command: rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm
                inst:
                  # install and configure services
                  packages:
                    yum:
                      aspnetcore-runtime-7.0: []
                  files:
                    /home/eondata/update.sh:
                      owner: eondata
                      group: eondata
                      mode: "000700"
                      content: !Sub |
                            #!/bin/bash
                            aws s3 sync s3://${EonDataWebDataBucketName}/bin/api/ /home/eondata/webapi/ --delete
                  commands:
                    eondataupdate:
                      command: sudo -u eondata /home/eondata/update.sh
                    instwebsvr:
                      command: amazon-linux-extras install -y nginx1
                cfgs:
                  # finalize configurations
                  files:
                    /etc/nginx/conf.d/eondata-api.conf:
                        owner: root
                        group: root
                        mode: "000640"
                        content: !Sub |
                            server {
                                listen 80;
                                server_name api.eondata.net;

                                location / {
                                    proxy_pass http://apisock/;
                                    proxy_http_version 1.1;
                                    proxy_set_header Upgrade $http_upgrade;
                                    proxy_set_header Connection keep-alive;
                                    proxy_set_header Host $host;
                                    proxy_cache_bypass $http_upgrade;
                                    proxy_set_header X-Real-IP $remote_addr;
                                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                                    proxy_set_header X-Forwarded-Proto $scheme;
                                }
                            }

                            upstream apisock {
                                server unix:/run/eondata-api.sock;
                            }
                  commands:
                    addnginxtogrp:
                      command: sudo usermod -aG eondata_nginx nginx
                    sysddreload:
                      command: systemctl daemon-reload
                    sysdenableserv:
                      command: systemctl enable eondata-api.service
                    sysdenablesock:
                      command: systemctl enable --now eondata-api.socket
                    websrvrestart:
                      command: systemctl restart nginx
    EonDataApiHostEC2AutoScale:
        Type: AWS::AutoScaling::AutoScalingGroup
        Properties:
            AutoScalingGroupName: EonDataApiHostAutoScaling
            DesiredCapacity: 1
            MinSize: 0
            MaxSize: 1
            Cooldown: 90
            VPCZoneIdentifier: !Ref WebHostSubnets
            LaunchTemplate:
                LaunchTemplateId: !Ref EonDataApiHostLaunchTemplate
                Version: 1
    EonDataWebApiCloudFrontDistribution:
        Type: AWS::CloudFront::Distribution
        Properties:
            DistributionConfig:
                Enabled: true
                Comment: EonData web api distribution
                HttpVersion: http2
                Aliases:
                    - api.eondata.net
                ViewerCertificate:
                    AcmCertificateArn: !Ref EonDataWebApiCertArn
                    SslSupportMethod: sni-only
                    MinimumProtocolVersion: TLSv1.2_2021
                Origins:
                    - Id: EonDataApiEC2Origin
                      DomainName: eondata-api.aws.eondata.net
                      CustomOriginConfig:
                        OriginProtocolPolicy: http-only
                        OriginReadTimeout: 30
                        OriginKeepaliveTimeout: 5
                    - Id: EonDataWebAppS3Origin
                      DomainName: !Sub ${EonDataWebAppBucketName}.s3.amazonaws.com
                      S3OriginConfig:
                        OriginAccessIdentity: !Sub origin-access-identity/cloudfront/${EonDataWebOriginAccess}
                DefaultCacheBehavior:
                    TargetOriginId: EonDataApiEC2Origin
                    MinTTL: 0
                    ViewerProtocolPolicy: redirect-to-https
                    Compress: true
                    ForwardedValues:
                        QueryString: true
                        Cookies:
                            Forward: none
                    AllowedMethods:
                        - GET
                        - HEAD
                        - OPTIONS
                    CachedMethods:
                        - GET
                        - HEAD
                    DefaultTTL: 30
                    MaxTTL: 86400
                Logging:
                    Bucket: !Sub ${EonDataWebDataBucketName}.s3.amazonaws.com
                    Prefix: logs/webapi/cf/
                    IncludeCookies: false
    EonDataApiHostIAMRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: EonDataApiHostIAMRole
            AssumeRolePolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Principal:
                    Service:
                      - ec2.amazonaws.com
                  Action:
                    - sts:AssumeRole
            Path: "/"
    EonDataApiIAMPolicyS3Access:
        Type: AWS::IAM::Policy
        Properties:
            PolicyName: EonDataApiIAMPolicyS3Access
            Roles:
                - !Ref EonDataApiHostIAMRole
            PolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Sid: EonDataApiS3Read
                      Effect: Allow
                      Action:
                        - s3:GetObject
                      Resource:
                        - !Sub arn:aws:s3:::${EonDataWebDataBucketName}/bin/api/*
                        - !Sub arn:aws:s3:::${EonDataWebDataBucketName}/contacts/*
                    - Sid: EonDataApiS3List
                      Effect: Allow
                      Action:
                        - s3:ListBucket
                      Resource:
                        - !Sub arn:aws:s3:::${EonDataWebDataBucketName}*
                    - Sid: EonDataApiS3Write
                      Effect: Allow
                      Action:
                        - s3:PutObject
                      Resource:
                        - !Sub arn:aws:s3:::${EonDataWebDataBucketName}/contacts/*
    EonDataWebIAMPolicyWriteLogs:
        Type: AWS::IAM::Policy
        Properties:
            PolicyName: EonDataWebIAMPolicyWriteLogs
            Roles:
                - !Ref EonDataApiHostIAMRole
            PolicyDocument:
                Version: "2012-10-17"
                Statement:
                    - Sid: EonDataWebIAMPolicyWriteLogs
                      Effect: Allow
                      Action:
                        - logs:CreateLogGroup
                        - logs:CreateLogStream
                        - logs:DescribeLogGroups
                        - logs:PutLogEvents
                      Resource:
                        - !Sub arn:aws:logs:*:*:log-group:${EonDataWebLogGroup}:*
    EonDataApiHostIAMProfile:
        Type: AWS::IAM::InstanceProfile
        Properties:
            InstanceProfileName: EonDataApiHostIAMProfile
            Roles:
              - !Ref EonDataApiHostIAMRole